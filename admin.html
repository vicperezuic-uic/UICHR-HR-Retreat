const SHEET_ID = "YOUR_SHEET_ID";
const API_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;

fetch(API_URL)
  .then(res => res.text())
  .then(text => {
    const json = JSON.parse(text.match(/google\.visualization\.Query\.setResponse\((.*)\)/s)[1]);
    const cols = json.table.cols.map(c => c.label);
    const rows = json.table.rows;

    const tableHead = document.getElementById("tableHead");
    const submissionTable = document.getElementById("submissionTable");

    // Header row
    const headRow = document.createElement("tr");
    cols.forEach(col => {
      const th = document.createElement("th");
      th.textContent = col;
      headRow.appendChild(th);
    });
    tableHead.appendChild(headRow);

    // Data rows
    rows.forEach(r => {
      const tr = document.createElement("tr");
      r.c.forEach(cell => {
        const td = document.createElement("td");
        td.textContent = cell?.v ?? "";
        tr.appendChild(td);
      });
      submissionTable.appendChild(tr);
    });

    // Download CSV
    document.getElementById("downloadBtn").addEventListener("click", () => {
      let csv = cols.join(",") + "\n";
      rows.forEach(r => {
        const rowVals = r.c.map(cell => (cell?.v ?? "").toString().replace(/,/g, " "));
        csv += rowVals.join(",") + "\n";
      });
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "UIC_Quiz_Submissions.csv";
      link.click();
    });
  })
  .catch(err => {
    console.error("Error loading data:", err);
    alert("Could not load submissions. Make sure the Sheet is published to the web.");
  });
