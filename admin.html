<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Admin Panel - UIC Quiz</title>
<style>
  body {
    font-family: 'Segoe UI', sans-serif;
    background: #f4f6f9;
    margin: 0;
    padding: 20px;
  }
  h1 {
    color: #d50032;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
    background: white;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  }
  th, td {
    border: 1px solid #ddd;
    padding: 10px;
    font-size: 14px;
    text-align: left;
  }
  th {
    background: #d50032;
    color: white;
  }
  button {
    background: #d50032;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    margin: 2px;
  }
  button:hover {
    background: #a00025;
  }
  #controls {
    margin-top: 10px;
  }
  input[type="email"] {
    padding: 6px;
    border-radius: 6px;
    border: 1px solid #ccc;
    width: 200px;
  }
</style>
</head>
<body>
<h1>Admin Dashboard - UIC Quiz</h1>
<p>Welcome, admin. Below are all quiz submissions.</p>

<div id="controls">
  <button id="downloadBtn">â¬‡ Download CSV</button>
  <input type="email" id="resetEmail" placeholder="User email">
  <button id="resetBtn">Reset Submission</button>
</div>

<table>
  <thead id="tableHead"></thead>
  <tbody id="submissionTable"></tbody>
</table>

<script>
  // --- Admin login check ---
  const allowedEmail = "vicperez@uic.edu";
  const allowedPassword = "Jujub1234!";
  const inputEmail = prompt("Enter admin email:");
  const inputPass = prompt("Enter admin password:");

  if(inputEmail !== allowedEmail || inputPass !== allowedPassword){
    alert("Access denied.");
    document.body.innerHTML = "<h2>Unauthorized</h2>";
    throw new Error("Unauthorized access");
  }

  // --- Web App URL ---
  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbx4X8BI0SkQI6NWn_yN8-0qGWV2x7tPncH77AZXvziIJ0khtwCdgRcVateUTPPH3uoS/exec";

  // --- Fetch submissions from Google Sheet ---
  async function loadSubmissions(){
    try {
      const res = await fetch(WEB_APP_URL + "?action=getAll");
      const data = await res.json();
      const tableHead = document.getElementById("tableHead");
      const tableBody = document.getElementById("submissionTable");

      // Clear previous content
      tableHead.innerHTML = "";
      tableBody.innerHTML = "";

      if(data.length === 0) {
        tableBody.innerHTML = "<tr><td colspan='10'>No submissions yet</td></tr>";
        return;
      }

      // Build header dynamically
      const headerRow = document.createElement("tr");
      Object.keys(data[0]).forEach(col => {
        const th = document.createElement("th");
        th.textContent = col;
        headerRow.appendChild(th);
      });
      headerRow.appendChild(document.createElement("th")).textContent = "Actions"; // Reset button column
      tableHead.appendChild(headerRow);

      // Build rows
      data.forEach(row => {
        const tr = document.createElement("tr");
        Object.values(row).forEach(val => {
          const td = document.createElement("td");
          td.textContent = val;
          tr.appendChild(td);
        });

        // Reset button for each row
        const actionTd = document.createElement("td");
        const resetBtn = document.createElement("button");
        resetBtn.textContent = "Reset";
        resetBtn.onclick = () => resetSubmission(row.Email);
        actionTd.appendChild(resetBtn);
        tr.appendChild(actionTd);

        tableBody.appendChild(tr);
      });
    } catch(err) {
      console.error("Error loading submissions:", err);
      alert("Could not load submissions.");
    }
  }

  // --- Download CSV ---
  document.getElementById("downloadBtn").addEventListener("click", () => {
    const rows = document.querySelectorAll("#submissionTable tr");
    if(rows.length === 0) return alert("No submissions to download.");
    let csvContent = "";
    const headers = Array.from(document.querySelectorAll("#tableHead th"))
      .map(h => h.textContent.replace(/,/g," "));
    csvContent += headers.join(",") + "\n";
    rows.forEach(row => {
      const values = Array.from(row.querySelectorAll("td"))
        .map(td => td.textContent.replace(/,/g," "));
      csvContent += values.join(",") + "\n";
    });
    const blob = new Blob([csvContent], {type: "text/csv;charset=utf-8;"});
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "UIC_Quiz_Responses.csv";
    link.click();
  });

  // --- Reset submission per email ---
  async function resetSubmission(email){
    if(!email) return alert("Email required to reset.");
    try {
      const res = await fetch(WEB_APP_URL, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ action: "reset", email: email })
      });
      const result = await res.json();
      if(result.result === "success") {
        alert(`Submission for ${email} has been reset.`);
        loadSubmissions();
      } else {
        alert(result.message || "Error resetting submission.");
      }
    } catch(err){
      console.error("Reset error:", err);
      alert("Error resetting submission.");
    }
  }

  // --- Attach reset button using input ---
  document.getElementById("resetBtn").addEventListener("click", () => {
    const email = document.getElementById("resetEmail").value.trim();
    resetSubmission(email);
  });

  // --- Initial load ---
  loadSubmissions();
</script>
</body>
</html>
