document.getElementById("submitBtn").addEventListener("click", function() {
  const submissions = JSON.parse(localStorage.getItem("quizSubmissions") || "{}");

  // Prevent duplicate local submissions
  if (submissions[currentUser]) {
    alert("You have already submitted.");
    return;
  }

  let score = 0;
  const userAnswers = [];

  questions.forEach((q, i) => {
    const songAnswer = document.getElementById(`song-${i}`).value.trim();
    const radios = document.getElementsByName(`requester-${i}`);
    let requesterAnswer = "";

    for (let r of radios) {
      if (r.checked) requesterAnswer = r.value;
    }

    userAnswers.push({ songAnswer, requesterAnswer });

    // Normalize strings: remove punctuation & lowercase
    const normalize = str => str.toLowerCase().replace(/[^a-z0-9\s]/gi,"").trim();

    // 1 point if song matches ignoring punctuation & case
    if(normalize(songAnswer) === normalize(q.correctSong)) score += 1;

    // 1 point if requester matches exactly
    if(requesterAnswer === q.correctRequester) score += 1;
  });

  // Store locally to prevent double-submission
  submissions[currentUser] = {
    score,
    submittedAt: new Date().toISOString(),
    answers: userAnswers
  };
  localStorage.setItem("quizSubmissions", JSON.stringify(submissions));

  // Send to Google Apps Script
  fetch("YOUR_DEPLOYED_WEB_APP_URL_HERE", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      email: currentUser,
      score: score,
      answers: userAnswers
    })
  })
  .then(r => r.json())
  .then(result => {
    if(result.result === "duplicate") {
      alert("This email has already submitted the quiz.");
      return;
    }
    alert(`Submission successful! You scored ${score} points.`);
    localStorage.removeItem("currentUser");
    window.location.href = "start.html";
  })
  .catch(err => {
    console.error("Error submitting:", err);
    alert("Error submitting quiz. Please try again.");
  });
});
